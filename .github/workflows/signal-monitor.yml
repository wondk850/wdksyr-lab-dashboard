name: WDK LAB Signal Monitor

on:
  schedule:
    # ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼ (KST 10:00 = UTC 01:00) - ë§¤ì¼!
    - cron: '0 1 * * *'
    
    # ğŸ“Š ì¥ ì‹œì‘ 1ì‹œê°„ ì „ ë¦¬í¬íŠ¸ (KST 22:30 = UTC 13:30) - ì›”~ê¸ˆ
    - cron: '30 13 * * 1-5'
    
    # ğŸ“Š ì¥ ì‹œì‘ ë¦¬í¬íŠ¸ (KST 23:30 = UTC 14:30) - ì›”~ê¸ˆ
    - cron: '30 14 * * 1-5'
    
    # ğŸ”„ ì¥ ì¤‘ ë°”í…€ì—… ì—…ë°ì´íŠ¸ - 30ë¶„ë§ˆë‹¤ (KST 23:30~03:00, 05:00~06:00) - ì›”~ê¸ˆ
    # UTC 14:30~18:00 (KST 23:30~03:00)
    - cron: '0,30 15-17 * * 1-5'
    # UTC 20:00~21:00 (KST 05:00~06:00)  
    - cron: '0,30 20 * * 1-5'
    
    # ğŸ“Š ì¥ ë§ˆê° ë¦¬í¬íŠ¸ (KST 06:00 = UTC 21:00) - ì›”~ê¸ˆ
    - cron: '0 21 * * 1-5'
    
    # ğŸ›ï¸ ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³  ì•Œë¦¼ (KST 11:00 = UTC 02:00) - ë§¤ì¼!
    - cron: '0 2 * * *'
    
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode (check, daily, report, news, bottomup, bid)'
        required: true
        default: 'bottomup'
        type: choice
        options:
          - check
          - daily
          - report
          - news
          - bottomup
          - bid
          - opengo


jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests yfinance pandas pandas-ta
      
      - name: Determine run mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          
          # KST 10:00 (UTC 01:00) = news
          if [ "$HOUR" = "01" ]; then
            echo "mode=news" >> $GITHUB_OUTPUT
          # KST 11:00 (UTC 02:00) = bid (ë‚˜ë¼ì¥í„°)
          elif [ "$HOUR" = "02" ]; then
            echo "mode=bid" >> $GITHUB_OUTPUT
          # KST 12:00 (UTC 03:00) = check (ê¸°ì¡´ news ë”œë ˆì´ ëŒ€ì‘ ì œê±°)
          elif [ "$HOUR" = "03" ]; then
            echo "mode=check" >> $GITHUB_OUTPUT
          # KST 22:30~23:29 (UTC 13:xx) = daily (ì¥ 1ì‹œê°„ ì „)
          elif [ "$HOUR" = "13" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 23:30~00:29 (UTC 14:xx) = daily (ì¥ ì‹œì‘)
          elif [ "$HOUR" = "14" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 06:00~07:00 (UTC 21:xx) = report (ì¥ ë§ˆê°)
          elif [ "$HOUR" = "21" ]; then
            echo "mode=report" >> $GITHUB_OUTPUT
          # ì¥ ì¤‘ 30ë¶„ ê°„ê²© (UTC 15-17, 20) = bottomupë§Œ ì—…ë°ì´íŠ¸
          elif [ "$HOUR" = "15" ] || [ "$HOUR" = "16" ] || [ "$HOUR" = "17" ] || [ "$HOUR" = "20" ]; then
            echo "mode=bottomup" >> $GITHUB_OUTPUT
          # ê·¸ ì™¸ = check
          else
            echo "mode=check" >> $GITHUB_OUTPUT
          fi
          
          # Manual trigger override
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download previous state
        uses: actions/download-artifact@v4
        with:
          name: signal-state
          path: .
        continue-on-error: true
      
      - name: Run WDK LAB Monitor
        if: steps.mode.outputs.mode != 'news' && steps.mode.outputs.mode != 'bottomup' && steps.mode.outputs.mode != 'bid'
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python wdklab_monitor.py ${{ steps.mode.outputs.mode }}
      
      - name: Generate Bottom-Up Data JSON
        if: steps.mode.outputs.mode == 'daily' || steps.mode.outputs.mode == 'report' || steps.mode.outputs.mode == 'bottomup'
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          python generate_bottomup_data.py
      
      - name: Commit and Push Bottom-Up Data
        if: steps.mode.outputs.mode == 'daily' || steps.mode.outputs.mode == 'report' || steps.mode.outputs.mode == 'bottomup'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bottomup_data.json
          git diff --staged --quiet || git commit -m "chore: ë°”í…€ì—… ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date +'%Y-%m-%d %H:%M')"
          git push
      
      - name: Download news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/download-artifact@v4
        with:
          name: news-state
          path: .
        continue-on-error: true
      
      - name: Run News Monitor
        if: steps.mode.outputs.mode == 'news'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python news_monitor.py news
      
      - name: Upload news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/upload-artifact@v4
        with:
          name: news-state
          path: news_sent.json
          retention-days: 30
          overwrite: true
      
      - name: Upload state
        uses: actions/upload-artifact@v4
        with:
          name: signal-state
          path: signal_state.json
          retention-days: 30
          overwrite: true
      
      # ğŸ›ï¸ ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³  ëª¨ë‹ˆí„°ë§
      - name: Download narajangteo state
        if: steps.mode.outputs.mode == 'bid'
        uses: actions/download-artifact@v4
        with:
          name: narajangteo-state
          path: .
        continue-on-error: true
      
      - name: Download opengo state
        if: steps.mode.outputs.mode == 'bid' || steps.mode.outputs.mode == 'opengo'
        uses: actions/download-artifact@v4
        with:
          name: opengo-state
          path: .
        continue-on-error: true
      
      - name: Run Narajangteo Monitor
        if: steps.mode.outputs.mode == 'bid'
        env:
          NARAJANGTEO_API_KEY: ${{ secrets.NARAJANGTEO_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python github-actions/narajangteo_monitor.py bid
          
      - name: Run Open.go.kr Monitor
        if: steps.mode.outputs.mode == 'bid' || steps.mode.outputs.mode == 'opengo'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          pip install playwright
          playwright install chromium
          python github-actions/opengo_monitor.py opengo
      
      - name: Upload narajangteo state
        if: steps.mode.outputs.mode == 'bid'
        uses: actions/upload-artifact@v4
        with:
          name: narajangteo-state
          path: github-actions/narajangteo_sent.json
          retention-days: 30
          overwrite: true
          
      - name: Upload opengo state
        if: steps.mode.outputs.mode == 'bid' || steps.mode.outputs.mode == 'opengo'
        uses: actions/upload-artifact@v4
        with:
          name: opengo-state
          path: github-actions/opengo_sent.json
          retention-days: 30
          overwrite: true

      # ğŸš¨ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì‹œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ (í† í° ë§Œë£Œ ë“± ì¡°ìš©í•œ ì˜¤ë¥˜ ë°©ì§€)
      - name: Notify failure via Telegram
        if: failure()
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=ğŸš¨ WDK LAB Actions ì‹¤íŒ¨!%0Aì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜ ë°œìƒ â€” í† í° ë§Œë£Œ ë˜ëŠ” API ì˜¤ë¥˜ í™•ì¸ ìš”ë§"
