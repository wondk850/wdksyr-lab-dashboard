name: WDK LAB Signal Monitor

on:
  schedule:
    # ðŸ“° ë‰´ìŠ¤ ì•Œë¦¼ (KST 10:00 = UTC 01:00) - ë§¤ì¼!
    - cron: '0 1 * * *'
    
    # ðŸ“Š ìž¥ ì‹œìž‘ 1ì‹œê°„ ì „ ë¦¬í¬íŠ¸ (KST 22:30 = UTC 13:30) - ì›”~ê¸ˆ
    - cron: '30 13 * * 1-5'
    
    # ðŸ“Š ìž¥ ì‹œìž‘ ë¦¬í¬íŠ¸ (KST 23:30 = UTC 14:30) - ì›”~ê¸ˆ
    - cron: '30 14 * * 1-5'
    
    # ðŸ”„ ìž¥ ì¤‘ 30ë¶„ë§ˆë‹¤ ì²´í¬ (KST 00:00~05:30 = UTC 15:00~20:30) - ì›”~ê¸ˆ
    - cron: '0,30 15-20 * * 1-5'
    
    # ðŸ“Š ìž¥ ë§ˆê° ë¦¬í¬íŠ¸ (KST 06:00 = UTC 21:00) - ì›”~ê¸ˆ
    - cron: '0 21 * * 1-5'
    
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode (check, daily, report, news)'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - daily
          - report
          - news


jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests yfinance
      
      - name: Determine run mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          MIN=$(date -u +%M)
          
          # KST 10:00 (UTC 01:00) = news
          if [ "$HOUR" = "01" ]; then
            echo "mode=news" >> $GITHUB_OUTPUT
          # KST 22:30 (UTC 13:30) = daily (ìž¥ 1ì‹œê°„ ì „)
          elif [ "$HOUR" = "13" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 23:30 (UTC 14:30) = daily (ìž¥ ì‹œìž‘)
          elif [ "$HOUR" = "14" ] && [ "$MIN" = "30" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 06:00 (UTC 21:00) = report (ìž¥ ë§ˆê°)
          elif [ "$HOUR" = "21" ]; then
            echo "mode=report" >> $GITHUB_OUTPUT
          # ê·¸ ì™¸ (ìž¥ ì¤‘) = check
          else
            echo "mode=check" >> $GITHUB_OUTPUT
          fi
          
          # Manual trigger override
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download previous state
        uses: actions/download-artifact@v4
        with:
          name: signal-state
          path: .
        continue-on-error: true
      
      - name: Run WDK LAB Monitor
        if: steps.mode.outputs.mode != 'news'
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python wdklab_monitor.py ${{ steps.mode.outputs.mode }}
      
      - name: Download news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/download-artifact@v4
        with:
          name: news-state
          path: .
        continue-on-error: true
      
      - name: Run News Monitor
        if: steps.mode.outputs.mode == 'news'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python news_monitor.py news
      
      - name: Upload news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/upload-artifact@v4
        with:
          name: news-state
          path: news_sent.json
          retention-days: 30
          overwrite: true
      
      - name: Upload state
        uses: actions/upload-artifact@v4
        with:
          name: signal-state
          path: signal_state.json
          retention-days: 30
          overwrite: true
