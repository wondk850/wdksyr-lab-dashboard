name: WDK LAB Signal Monitor

on:
  schedule:
    # üì∞ Îâ¥Ïä§ ÏïåÎ¶º (KST 10:00 = UTC 01:00) - Îß§Ïùº!
    - cron: '0 1 * * *'
    
    # üìä Ïû• ÏãúÏûë 1ÏãúÍ∞Ñ Ï†Ñ Î¶¨Ìè¨Ìä∏ (KST 22:30 = UTC 13:30) - Ïõî~Í∏à
    - cron: '30 13 * * 1-5'
    
    # üìä Ïû• ÏãúÏûë Î¶¨Ìè¨Ìä∏ (KST 23:30 = UTC 14:30) - Ïõî~Í∏à
    - cron: '30 14 * * 1-5'
    
    # üîÑ Ïû• Ï§ë Î∞îÌÖÄÏóÖ ÏóÖÎç∞Ïù¥Ìä∏ - 30Î∂ÑÎßàÎã§ (KST 23:30~03:00, 05:00~06:00) - Ïõî~Í∏à
    # UTC 14:30~18:00 (KST 23:30~03:00)
    - cron: '0,30 15-17 * * 1-5'
    # UTC 20:00~21:00 (KST 05:00~06:00)  
    - cron: '0,30 20 * * 1-5'
    
    # üìä Ïû• ÎßàÍ∞ê Î¶¨Ìè¨Ìä∏ (KST 06:00 = UTC 21:00) - Ïõî~Í∏à
    - cron: '0 21 * * 1-5'
    
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode (check, daily, report, news, bottomup)'
        required: true
        default: 'bottomup'
        type: choice
        options:
          - check
          - daily
          - report
          - news
          - bottomup


jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests yfinance
      
      - name: Determine run mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          
          # KST 10:00~12:00 (UTC 01:00~03:00) = news (ÎîúÎ†àÏù¥ ÎåÄÏùë!)
          if [ "$HOUR" = "01" ] || [ "$HOUR" = "02" ] || [ "$HOUR" = "03" ]; then
            echo "mode=news" >> $GITHUB_OUTPUT
          # KST 22:30~23:29 (UTC 13:xx) = daily (Ïû• 1ÏãúÍ∞Ñ Ï†Ñ)
          elif [ "$HOUR" = "13" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 23:30~00:29 (UTC 14:xx) = daily (Ïû• ÏãúÏûë)
          elif [ "$HOUR" = "14" ]; then
            echo "mode=daily" >> $GITHUB_OUTPUT
          # KST 06:00~07:00 (UTC 21:xx) = report (Ïû• ÎßàÍ∞ê)
          elif [ "$HOUR" = "21" ]; then
            echo "mode=report" >> $GITHUB_OUTPUT
          # Ïû• Ï§ë 30Î∂Ñ Í∞ÑÍ≤© (UTC 15-17, 20) = bottomupÎßå ÏóÖÎç∞Ïù¥Ìä∏
          elif [ "$HOUR" = "15" ] || [ "$HOUR" = "16" ] || [ "$HOUR" = "17" ] || [ "$HOUR" = "20" ]; then
            echo "mode=bottomup" >> $GITHUB_OUTPUT
          # Í∑∏ Ïô∏ = check
          else
            echo "mode=check" >> $GITHUB_OUTPUT
          fi
          
          # Manual trigger override
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download previous state
        uses: actions/download-artifact@v4
        with:
          name: signal-state
          path: .
        continue-on-error: true
      
      - name: Run WDK LAB Monitor
        if: steps.mode.outputs.mode != 'news' && steps.mode.outputs.mode != 'bottomup'
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python wdklab_monitor.py ${{ steps.mode.outputs.mode }}
      
      - name: Generate Bottom-Up Data JSON
        if: steps.mode.outputs.mode == 'daily' || steps.mode.outputs.mode == 'report' || steps.mode.outputs.mode == 'bottomup'
        run: |
          python generate_bottomup_data.py
      
      - name: Commit and Push Bottom-Up Data
        if: steps.mode.outputs.mode == 'daily' || steps.mode.outputs.mode == 'report' || steps.mode.outputs.mode == 'bottomup'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bottomup_data.json
          git diff --staged --quiet || git commit -m "chore: Î∞îÌÖÄÏóÖ Îç∞Ïù¥ÌÑ∞ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ $(date +'%Y-%m-%d %H:%M')"
          git push
      
      - name: Download news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/download-artifact@v4
        with:
          name: news-state
          path: .
        continue-on-error: true
      
      - name: Run News Monitor
        if: steps.mode.outputs.mode == 'news'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python news_monitor.py news
      
      - name: Upload news state
        if: steps.mode.outputs.mode == 'news'
        uses: actions/upload-artifact@v4
        with:
          name: news-state
          path: news_sent.json
          retention-days: 30
          overwrite: true
      
      - name: Upload state
        uses: actions/upload-artifact@v4
        with:
          name: signal-state
          path: signal_state.json
          retention-days: 30
          overwrite: true
