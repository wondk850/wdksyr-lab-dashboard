<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDK LAB 바텀업 스코어카드 v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .rank-gold { background-color: #fffbeb; }
        .rank-silver { background-color: #f8fafc; }
        .rank-bronze { background-color: #fdf8f6; }
        .score-positive { color: #16a34a; }
        .score-negative { color: #dc2626; }
        .score-neutral { color: #64748b; }
        .tooltip-container { position: relative; display: inline-block; cursor: help; }
        .tooltip-text { visibility: hidden; width: 160px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">WDK LAB 바텀업 스코어카드</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">최정예 빅테크 요원 선발 시스템 (v3.0)</p>
            <div class="mt-4">
                <a href="./index.html" class="text-emerald-500 hover:text-emerald-600 transition-colors">← 홈 (탑다운 대시보드)으로 돌아가기</a>
            </div>
        </header>

        <section id="scoreboard">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-700 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="px-4 py-3">순위</th>
                                <th class="px-4 py-3">종목</th>
                                <th class="px-4 py-3 text-center">모멘텀 (40%)</th>
                                <th class="px-4 py-3 text-center">펀더멘탈 (40%)</th>
                                <th class="px-4 py-3 text-center">밸류에이션 (20%)</th>
                                <th class="px-4 py-3 text-center">최종 점수</th>
                            </tr>
                        </thead>
                        <tbody id="scoreboard-body">
                            </tbody>
                    </table>
                </div>
                 <p class="text-xs text-slate-400 mt-4 text-right">Last Updated: <span id="last-updated">-</span></p>
            </div>
        </section>
    </div>

<script>
const PROXY_URL = 'https://api.allorigins.win/get?url=';
const TICKERS = ['NVDA', 'MSFT', 'AAPL', 'GOOGL', 'AMZN', 'META', 'TSLA'];

const scoreboardBody = document.getElementById('scoreboard-body');
const lastUpdatedEl = document.getElementById('last-updated');
const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
const CLAMP = (v, a, b) => Math.max(a, Math.min(b, v));

function robustParseNumber(raw) {
    if (raw == null) return null;
    let s = String(raw).trim();
    if (s === '-' || /^n\/a$/i.test(s) || s.length === 0) return null;

    let negative = false;
    if (s.startsWith('(') && s.endsWith(')')) {
        negative = true;
        s = s.slice(1, -1).trim();
    }

    s = s.replace(/,/g, '').replace(/\s+/g, '');
    const isPercent = s.endsWith('%');
    if (isPercent) s = s.slice(0, -1);

    const m = s.match(/^([+-]?\d*\.?\d+)([KMBT])?$/i);
    if (!m) {
        const v = parseFloat(s);
        return Number.isFinite(v) ? (negative ? -v : v) : null;
    }
    let num = parseFloat(m[1]);
    const suf = m[2] ? m[2].toUpperCase() : null;
    if (suf) {
        if (suf === 'K') num *= 1e3;
        else if (suf === 'M') num *= 1e6;
        else if (suf === 'B') num *= 1e9;
        else if (suf === 'T') num *= 1e12;
    }
    return negative ? -num : num;
}

function getField(data, variants) {
    const keys = Object.keys(data || {});
    for (const v of variants) {
        const exact = keys.find(k => k.trim().toLowerCase() === v.trim().toLowerCase());
        if (exact && data[exact] !== undefined) return data[exact];
    }
    for (const v of variants) {
        const found = keys.find(k => k.toLowerCase().includes(v.trim().toLowerCase()));
        if (found && data[found] !== undefined) return data[found];
    }
    return undefined;
}

async function fetchTickerData(ticker, retries = 2) {
    const finvizUrl = `https://finviz.com/quote.ashx?t=${ticker}`;
    const requestUrl = `${PROXY_URL}${encodeURIComponent(finvizUrl)}`;
    
    for (let attempt = 0; attempt <= retries; attempt++) {
        try {
            const response = await fetch(requestUrl);
            if (!response.ok) throw new Error(`Proxy status ${response.status}`);
            const json = await response.json();
            const htmlText = json.contents;
            if (!htmlText) throw new Error('No html content from proxy');

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            const table = doc.querySelector('.snapshot-table2');
            if (!table) throw new Error('Data table not found in HTML');

            const cells = Array.from(table.querySelectorAll('td'));
            const data = {};
            for (let i = 0; i < cells.length; i += 2) {
                const key = (cells[i].textContent || '').trim();
                const value = (cells[i + 1] && cells[i + 1].textContent) ? cells[i + 1].textContent.trim() : '';
                if (key) data[key] = value;
            }
            console.debug(`[${ticker}] parsed keys:`, Object.keys(data));
            return { ticker, data };
        } catch (err) {
            console.warn(`fetch ${ticker} attempt ${attempt+1} failed:`, err);
            if (attempt === retries) return { ticker, error: err.message || String(err) };
            await sleep(500 * Math.pow(2, attempt));
        }
    }
}

async function fetchAllTickers(tickers, concurrency = 3) {
    const results = [];
    for (let i = 0; i < tickers.length; i += concurrency) {
        const batch = tickers.slice(i, i + concurrency);
        const batchPromises = batch.map(t => fetchTickerData(t));
        const batchRes = await Promise.all(batchPromises);
        results.push(...batchRes);
        if (i + concurrency < tickers.length) await sleep(300);
    }
    return results;
}

function calculateScoresNormalized(rawResults) {
    const metrics = rawResults.map(r => {
        const d = r.data || {};
        return {
            ticker: r.ticker,
            error: r.error,
            rsi: robustParseNumber(getField(d, ['RSI (14)', 'RSI'])),
            sma200Text: getField(d, ['SMA200']),
            salesQQ: robustParseNumber(getField(d, ['Sales Q/Q'])),
            epsQQ: robustParseNumber(getField(d, ['EPS Q/Q'])),
            pe: robustParseNumber(getField(d, ['P/E'])),
            epsNext5y: robustParseNumber(getField(d, ['EPS next 5Y']))
        };
    });

    metrics.forEach(m => {
        m.peg = (m.pe > 0 && m.epsNext5y > 0) ? m.pe / m.epsNext5y : null;
    });

    const getStats = (key) => {
        const vals = metrics.map(x => x[key]).filter(v => v != null && isFinite(v));
        if (vals.length === 0) return { min: 0, max: 0 };
        return { min: Math.min(...vals), max: Math.max(...vals) };
    };
    const stats = {
        salesQQ: getStats('salesQQ'),
        epsQQ: getStats('epsQQ'),
        peg: getStats('peg')
    };

    const minMaxNorm = (v, key, invert = false) => {
        const s = stats[key];
        if (v == null || !s || s.max === s.min) return 0;
        const scaled = (v - s.min) / (s.max - s.min);
        const result = CLAMP(scaled * 2 - 1, -1, 1);
        return invert ? -result : result;
    };

    return metrics.map(m => {
        const rsiScore = (m.rsi != null) ? CLAMP((m.rsi - 50) / 50, -1, 1) : 0;
        const smaSign = m.sma200Text ? (/above/i.test(m.sma200Text) ? 1 : (/below/i.test(m.sma200Text) ? -1 : 0)) : 0;
        const momentum = CLAMP(0.7 * rsiScore + 0.3 * smaSign, -1, 1);

        const salesN = minMaxNorm(m.salesQQ, 'salesQQ');
        const epsN = minMaxNorm(m.epsQQ, 'epsQQ');
        const fundamental = CLAMP(0.4 * salesN + 0.6 * epsN, -1, 1);

        const valuation = minMaxNorm(m.peg, 'peg', true); // Invert because lower PEG is better

        const finalScore = (momentum * 0.4) + (fundamental * 0.4) + (valuation * 0.2);

        return { ticker: m.ticker, error: m.error, scores: { momentum, fundamental, valuation, peg: m.peg }, finalScore };
    });
}

function renderScoreboard(results) {
    results.sort((a, b) => b.finalScore - a.finalScore);
    scoreboardBody.innerHTML = '';

    results.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b dark:border-slate-700';
        if (idx === 0) tr.classList.add('rank-gold');
        else if (idx === 1) tr.classList.add('rank-silver');
        else if (idx === 2) tr.classList.add('rank-bronze');

        const createCell = (content, className = '') => {
            const td = document.createElement('td');
            td.className = `px-4 py-4 ${className}`;
            if (typeof content === 'string' || typeof content === 'number') {
                td.textContent = content;
            } else {
                td.appendChild(content);
            }
            return td;
        };

        tr.appendChild(createCell(idx + 1, 'font-bold text-lg'));
        tr.appendChild(createCell(r.ticker, 'font-bold text-slate-900 dark:text-slate-100'));

        if (r.error || !r.scores) {
            const tdError = createCell(`데이터 로딩 실패: ${r.error || 'N/A'}`, 'text-center text-red-500');
            tdError.colSpan = 4;
            tr.appendChild(tdError);
        } else {
            const createScoreCell = (score, tooltipText = '') => {
                const span = document.createElement('span');
                span.className = 'font-bold';
                span.textContent = score.toFixed(2);
                if (score > 0.1) span.classList.add('score-positive');
                else if (score < -0.1) span.classList.add('score-negative');
                else span.classList.add('score-neutral');

                if (tooltipText) {
                    const container = document.createElement('div');
                    container.className = 'tooltip-container';
                    const tip = document.createElement('span');
                    tip.className = 'tooltip-text';
                    tip.textContent = tooltipText;
                    container.append(span, tip);
                    return createCell(container, 'text-center');
                }
                return createCell(span, 'text-center');
            };
            
            tr.appendChild(createScoreCell(r.scores.momentum));
            tr.appendChild(createScoreCell(r.scores.fundamental));
            tr.appendChild(createScoreCell(r.scores.valuation, r.scores.peg ? `PEG: ${r.scores.peg.toFixed(2)}` : 'PEG 계산 불가'));
            tr.appendChild(createScoreCell(r.finalScore));
        }
        scoreboardBody.appendChild(tr);
    });

    lastUpdatedEl.textContent = new Date().toLocaleString('ko-KR');
}

async function main() {
    scoreboardBody.innerHTML = TICKERS.map(() => `
        <tr class="border-b dark:border-slate-700">
            <td class="px-4 py-4"><div class="h-4 w-4 bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
            <td class="px-4 py-4 font-bold"><div class="h-4 w-16 bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
            <td class="px-4 py-4 text-center"><div class="h-4 w-12 mx-auto bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
            <td class="px-4 py-4 text-center"><div class="h-4 w-12 mx-auto bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
            <td class="px-4 py-4 text-center"><div class="h-4 w-12 mx-auto bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
            <td class="px-4 py-4 text-center"><div class="h-4 w-12 mx-auto bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
        </tr>
    `).join('');

    try {
        const raw = await fetchAllTickers(TICKERS, 3);
        const scored = calculateScoresNormalized(raw);
        renderScoreboard(scored);
    } catch (err) {
        console.error('main error', err);
        scoreboardBody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">치명적 오류: ${String(err)}</td></tr>`;
        lastUpdatedEl.textContent = new Date().toLocaleString('ko-KR');
    }
}

document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
