<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDK LAB ë°”í…€ì—… ìŠ¤ì½”ì–´ì¹´ë“œ v3.4 (2026.02.01)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }

        .score-positive {
            color: #16a34a;
        }

        .score-negative {
            color: #dc2626;
        }

        .score-neutral {
            color: #64748b;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #2d3748;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .rank-gold {
            background-color: rgba(251, 191, 36, 0.1);
        }

        .rank-silver {
            background-color: rgba(156, 163, 175, 0.1);
        }

        .rank-bronze {
            background-color: rgba(180, 83, 9, 0.05);
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">WDK LAB ë°”í…€ì—… ìŠ¤ì½”ì–´ì¹´ë“œ v3.4</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">ì •ëŸ‰ì  ì—°ì†í˜• ì ìˆ˜ ê¸°ë°˜ ìµœì •ì˜ˆ ìš”ì› ì„ ë°œ ì‹œìŠ¤í…œ</p>
            <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026.02.01 | FMP API ì¶”ê°€</p>
            <p id="data-status" class="text-xs text-emerald-500 mt-1">ğŸ“¡ ë°ì´í„° ë¡œë”© ì¤‘...</p>
            <div class="mt-4 flex justify-center items-center space-x-4">
                <a href="./dashboard_topdown.html" class="text-emerald-500 hover:text-emerald-600 transition-colors">â†
                    íƒ‘ë‹¤ìš´ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
                <button id="refresh-btn"
                    class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                    title="ìƒˆë¡œê³ ì¹¨">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button id="clear-cache-btn"
                    class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                    title="ìºì‹œ ì‚­ì œ í›„ ì¬ë¡œë”©">ğŸ—‘ï¸ ìºì‹œ í´ë¦¬ì–´</button>
            </div>
        </header>

        <section id="scoreboard">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead
                            class="text-xs text-slate-700 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="px-4 py-3">ìˆœìœ„</th>
                                <th class="px-4 py-3">ì¢…ëª©</th>
                                <th class="px-4 py-3 text-center">ëª¨ë©˜í…€ (45%)</th>
                                <th class="px-4 py-3 text-center">í€ë”ë©˜íƒˆ (35%)</th>
                                <th class="px-4 py-3 text-center">ë°¸ë¥˜ì—ì´ì…˜ (20%)</th>
                                <th class="px-4 py-3 text-center">ìµœì¢… ì ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="scoreboard-body">
                            <!-- Skeleton loading rows -->
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-slate-400 mt-4 text-right">Last Updated: <span id="last-updated">-</span></p>
            </div>
        </section>
    </div>

    <script>
        // í‹°ì»¤ ëª©ë¡
        const TICKERS = [
            'MSFT', 'AAPL', 'GOOGL', 'AMZN', 'META', 'TSLA', // Big Tech
            'NVDA', 'TSM', 'ASML',                           // Semiconductors
            'LLY',                                           // Healthcare
            'JPM', 'V',                                      // Financials
            'XOM',                                           // Energy
            'WMT', 'COST',                                   // Consumer Staples
            'GE', 'CAT'                                      // Industrials
        ];

        // ===== FMP API (ê°€ì¥ ì•ˆì •ì !) =====
        const FMP_API_KEY = 'I3Z7ojCPBjEuSSkCUjCm6Jq436MUwlML';

        // ì—¬ëŸ¬ CORS í”„ë¡ì‹œë¥¼ fallbackìœ¼ë¡œ ì‚¬ìš© (FMP ì‹¤íŒ¨ ì‹œ)
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors-anywhere.herokuapp.com/',
            'https://thingproxy.freeboard.io/fetch/',
            'https://yacdn.org/proxy/',
        ];

        // Yahoo Finance ì—”ë“œí¬ì¸íŠ¸ (FMP ì‹¤íŒ¨ ì‹œ fallback)
        const YAHOO_V8_ENDPOINTS = [
            'https://query1.finance.yahoo.com/v8/finance/chart/',
            'https://query2.finance.yahoo.com/v8/finance/chart/',
        ];

        // ìºì‹œ (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€) - ì‹¤íŒ¨í•œ í”„ë¡ì‹œ ê±´ë„ˆë›°ê¸°ìš©
        let failedProxies = new Set();
        let tickerCache = {};

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìºì‹œ ë¡œë“œ (24ì‹œê°„ ìœ íš¨)
        try {
            const cached = localStorage.getItem('wdk_ticker_cache');
            const cacheTime = localStorage.getItem('wdk_ticker_cache_time');
            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < 24 * 60 * 60 * 1000) { // 24ì‹œê°„ ì´ë‚´
                    tickerCache = JSON.parse(cached);
                    console.log('[Cache] Loaded from localStorage');
                }
            }
        } catch (e) { }


        const scoreboardBody = document.getElementById('scoreboard-body');
        const lastUpdatedEl = document.getElementById('last-updated');
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function showInitialSkeleton() {
            let skeletonHTML = '';
            TICKERS.forEach(ticker => {
                skeletonHTML += `
            <tr id="row-${ticker}" class="border-b dark:border-slate-700">
                <td class="px-4 py-4 text-center align-middle"><div class="h-4 w-4 bg-slate-200 dark:bg-slate-700 rounded skeleton"></div></td>
                <td class="px-4 py-4 font-bold align-middle">${ticker}</td>
                <td id="status-cell-${ticker}" colspan="4" class="px-4 py-4 text-center align-middle">
                    <div class="h-4 w-full bg-slate-200 dark:bg-slate-700 rounded skeleton"></div>
                </td>
            </tr>
        `;
            });
            scoreboardBody.innerHTML = skeletonHTML;
        }

        // ì£¼ì‹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (FMP â†’ Yahoo v8 â†’ Yahoo v10 â†’ Finviz)
        async function fetchTickerData(ticker, retries = 2) {
            // ìºì‹œ í™•ì¸
            if (tickerCache[ticker]) {
                console.log(`[Cache] Using cached data for ${ticker}`);
                return tickerCache[ticker];
            }

            // íƒ€ì„ì•„ì›ƒ í•¨ìˆ˜
            const fetchWithTimeout = async (url, timeout = 8000) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(url, {
                        headers: { 'Accept': 'application/json' },
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            };

            // ===== ë°©ë²• 0: FMP API (ê°€ì¥ ì•ˆì •ì ! ê³µì‹ API!) =====
            console.log(`[FMP] Trying ${ticker}...`);
            try {
                const fmpUrl = `https://financialmodelingprep.com/api/v3/profile/${ticker}?apikey=${FMP_API_KEY}`;
                const fmpQuoteUrl = `https://financialmodelingprep.com/api/v3/quote/${ticker}?apikey=${FMP_API_KEY}`;
                const fmpRatioUrl = `https://financialmodelingprep.com/api/v3/ratios-ttm/${ticker}?apikey=${FMP_API_KEY}`;

                // ë³‘ë ¬ ìš”ì²­
                const [profileRes, quoteRes, ratioRes] = await Promise.all([
                    fetchWithTimeout(fmpUrl, 10000),
                    fetchWithTimeout(fmpQuoteUrl, 10000),
                    fetchWithTimeout(fmpRatioUrl, 10000)
                ]);

                if (profileRes.ok && quoteRes.ok) {
                    const [profiles, quotes, ratios] = await Promise.all([
                        profileRes.json(),
                        quoteRes.json(),
                        ratioRes.ok ? ratioRes.json() : Promise.resolve([{}])
                    ]);

                    const profile = profiles[0] || {};
                    const quote = quotes[0] || {};
                    const ratio = ratios[0] || {};

                    if (profile.symbol || quote.symbol) {
                        const currentPrice = quote.price || profile.price || 0;
                        const previousClose = quote.previousClose || currentPrice;
                        const changePercent = quote.changesPercentage || ((currentPrice - previousClose) / previousClose * 100);

                        const data = {
                            'Price': currentPrice.toFixed(2),
                            'Change': changePercent.toFixed(2) + '%',
                            '52W High': (quote.yearHigh || 0).toFixed(2),
                            '52W Low': (quote.yearLow || 0).toFixed(2),
                            'Perf Year': quote.priceAvg200 ? ((currentPrice / quote.priceAvg200 - 1) * 100).toFixed(2) + '%' : '-',
                            'SMA200': quote.priceAvg200 ? (currentPrice > quote.priceAvg200 ? 'above' : 'below') : '-',
                            'Perf Week': '-', 'Perf Month': '-', 'Perf Quarter': '-', 'Perf Half Y': '-',
                            'RSI (14)': '-',
                            'Beta': profile.beta ? profile.beta.toFixed(2) : '-',
                            'EPS Q/Q': '-',
                            'Sales Q/Q': '-',
                            'EPS next Y': '-',
                            'Gross Margin': ratio.grossProfitMarginTTM ? (ratio.grossProfitMarginTTM * 100).toFixed(2) + '%' : '-',
                            'Operating Margin': ratio.operatingProfitMarginTTM ? (ratio.operatingProfitMarginTTM * 100).toFixed(2) + '%' : '-',
                            'Profit Margin': ratio.netProfitMarginTTM ? (ratio.netProfitMarginTTM * 100).toFixed(2) + '%' : '-',
                            'ROE': ratio.returnOnEquityTTM ? (ratio.returnOnEquityTTM * 100).toFixed(2) + '%' : '-',
                            'ROA': ratio.returnOnAssetsTTM ? (ratio.returnOnAssetsTTM * 100).toFixed(2) + '%' : '-',
                            'P/E': ratio.peRatioTTM ? ratio.peRatioTTM.toFixed(2) : (quote.pe ? quote.pe.toFixed(2) : '-'),
                            'Forward P/E': '-',
                            'PEG': ratio.pegRatioTTM ? ratio.pegRatioTTM.toFixed(2) : '-',
                            'P/B': ratio.priceToBookRatioTTM ? ratio.priceToBookRatioTTM.toFixed(2) : '-',
                            'P/FCF': ratio.priceToFreeCashFlowsRatioTTM ? ratio.priceToFreeCashFlowsRatioTTM.toFixed(2) : '-',
                            'Dividend': ratio.dividendYielTTM ? (ratio.dividendYielTTM * 100).toFixed(2) + '%' : '-',
                        };

                        const result_obj = { ticker, data };
                        tickerCache[ticker] = result_obj;
                        console.log(`[FMP] âœ… ${ticker} loaded successfully`);
                        return result_obj;
                    }
                }
                throw new Error('FMP returned empty data');
            } catch (error) {
                console.warn(`[FMP] ${ticker} failed: ${error.message}, trying Yahoo v8...`);
            }

            // ===== ë°©ë²• 1: Yahoo Finance v8 (Chart API) =====
            console.log(`[Yahoo v8] Trying ${ticker}...`);
            for (const endpoint of YAHOO_V8_ENDPOINTS) {
                for (const proxy of CORS_PROXIES) {
                    if (failedProxies.has(proxy)) continue;

                    try {
                        const v8Url = `${endpoint}${ticker}?interval=1d&range=1y`;
                        const requestUrl = `${proxy}${encodeURIComponent(v8Url)}`;

                        const response = await fetchWithTimeout(requestUrl, 6000);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        const json = await response.json();
                        const chart = json?.chart?.result?.[0];
                        if (!chart || !chart.meta) throw new Error('No chart data');

                        const meta = chart.meta;
                        const quote = chart.indicators?.quote?.[0] || {};
                        const closes = quote.close || [];
                        const currentPrice = meta.regularMarketPrice || closes[closes.length - 1] || 0;
                        const fiftyTwoWeekHigh = meta.fiftyTwoWeekHigh || 0;
                        const fiftyTwoWeekLow = meta.fiftyTwoWeekLow || 0;
                        const previousClose = meta.chartPreviousClose || meta.previousClose || currentPrice;

                        // 52ì£¼ ë³€ë™ë¥  ê³„ì‚°
                        const oneYearAgoPrice = closes[0] || currentPrice;
                        const perfYear = oneYearAgoPrice ? ((currentPrice - oneYearAgoPrice) / oneYearAgoPrice * 100).toFixed(2) + '%' : '-';

                        // 200ì¼ í‰ê·  ê³„ì‚°
                        const last200 = closes.slice(-200);
                        const sma200 = last200.length > 0 ? last200.reduce((a, b) => a + (b || 0), 0) / last200.length : currentPrice;

                        const data = {
                            'Price': currentPrice.toFixed(2),
                            'Change': ((currentPrice - previousClose) / previousClose * 100).toFixed(2) + '%',
                            '52W High': fiftyTwoWeekHigh.toFixed(2),
                            '52W Low': fiftyTwoWeekLow.toFixed(2),
                            'Perf Year': perfYear,
                            'SMA200': currentPrice > sma200 ? 'above' : 'below',
                            // ê¸°ë³¸ê°’ ì„¤ì •
                            'Perf Week': '-', 'Perf Month': '-', 'Perf Quarter': '-', 'Perf Half Y': '-',
                            'RSI (14)': '-', 'Beta': '-',
                            'EPS Q/Q': '-', 'Sales Q/Q': '-', 'EPS next Y': '-',
                            'Gross Margin': '-', 'Operating Margin': '-', 'Profit Margin': '-',
                            'ROE': '-', 'ROA': '-',
                            'P/E': '-', 'Forward P/E': '-', 'PEG': '-', 'P/B': '-', 'P/FCF': '-',
                            'Dividend': '-',
                        };

                        const result_obj = { ticker, data };
                        tickerCache[ticker] = result_obj;
                        console.log(`[Yahoo v8] âœ… ${ticker} loaded successfully`);
                        return result_obj;

                    } catch (error) {
                        console.warn(`[Yahoo v8] ${ticker} failed (${proxy.split('/')[2]}): ${error.message}`);
                    }
                }
            }

            // ===== ë°©ë²• 2: Yahoo Finance v10 (Summary API) =====
            const yahooUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=price,summaryDetail,defaultKeyStatistics,financialData`;

            console.log(`[Yahoo v10] Trying ${ticker}...`);
            for (const proxy of CORS_PROXIES) {
                if (failedProxies.has(proxy)) continue;

                for (let attempt = 0; attempt <= retries; attempt++) {
                    try {
                        const requestUrl = `${proxy}${encodeURIComponent(yahooUrl)}`;

                        const response = await fetchWithTimeout(requestUrl, 8000);

                        if (!response.ok) {
                            if (response.status === 429) {
                                failedProxies.add(proxy);
                                break;
                            }
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const json = await response.json();
                        const result = json?.quoteSummary?.result?.[0];

                        if (!result) throw new Error('No data returned');

                        const price = result.price || {};
                        const summary = result.summaryDetail || {};
                        const keyStats = result.defaultKeyStatistics || {};
                        const financial = result.financialData || {};

                        const data = {
                            'Price': price.regularMarketPrice?.fmt || '-',
                            'Change': price.regularMarketChangePercent?.fmt || '-',
                            '52W High': summary.fiftyTwoWeekHigh?.fmt || '-',
                            '52W Low': summary.fiftyTwoWeekLow?.fmt || '-',
                            'Perf Week': '-', 'Perf Month': '-', 'Perf Quarter': '-', 'Perf Half Y': '-',
                            'Perf Year': keyStats.fiftyTwoWeekChange?.fmt || '-',
                            'RSI (14)': '-',
                            'SMA200': price.regularMarketPrice?.raw > (summary.twoHundredDayAverage?.raw || 0) ? 'above' : 'below',
                            'Beta': summary.beta?.fmt || keyStats.beta?.fmt || '-',
                            'EPS Q/Q': keyStats.earningsQuarterlyGrowth?.fmt || '-',
                            'Sales Q/Q': keyStats.revenueQuarterlyGrowth?.fmt || '-',
                            'EPS next Y': keyStats.earningsGrowth?.fmt || '-',
                            'Gross Margin': financial.grossMargins?.fmt || '-',
                            'Operating Margin': financial.operatingMargins?.fmt || '-',
                            'Profit Margin': financial.profitMargins?.fmt || '-',
                            'ROE': financial.returnOnEquity?.fmt || '-',
                            'ROA': financial.returnOnAssets?.fmt || '-',
                            'P/E': summary.trailingPE?.fmt || keyStats.trailingPE?.fmt || '-',
                            'Forward P/E': summary.forwardPE?.fmt || keyStats.forwardPE?.fmt || '-',
                            'PEG': keyStats.pegRatio?.fmt || '-',
                            'P/B': keyStats.priceToBook?.fmt || '-',
                            'P/FCF': '-',
                            'Dividend': summary.dividendYield?.fmt || '-',
                        };

                        const result_obj = { ticker, data };
                        tickerCache[ticker] = result_obj;
                        console.log(`[Yahoo v10] âœ… ${ticker} loaded successfully`);
                        return result_obj;

                    } catch (error) {
                        console.warn(`[Yahoo v10] ${ticker} attempt ${attempt + 1} failed: ${error.message}`);
                        if (attempt < retries) await sleep(300);
                    }
                }
            }

            // ===== ë°©ë²• 3: Finviz Fallback =====
            console.warn(`[Yahoo] âŒ All Yahoo attempts failed for ${ticker}, trying Finviz...`);
            return await fetchFinvizFallback(ticker);
        }

        // Finviz fallback (ì—¬ëŸ¬ í”„ë¡ì‹œ ì‹œë„)
        async function fetchFinvizFallback(ticker) {
            const finvizUrl = `https://finviz.com/quote.ashx?t=${ticker}`;

            for (const proxy of CORS_PROXIES) {
                if (failedProxies.has(proxy)) continue;

                try {
                    const requestUrl = `${proxy}${encodeURIComponent(finvizUrl)}`;
                    console.log(`[Finviz] Trying ${ticker} via ${proxy.split('/')[2]}...`);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);

                    const response = await fetch(requestUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    let htmlText = await response.text();
                    if (!htmlText) throw new Error('No HTML content');

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    const data = {};
                    const table = doc.querySelector('.snapshot-table2');
                    if (!table) throw new Error('Finviz table not found');

                    const cells = table.querySelectorAll('td');
                    for (let j = 0; j < cells.length; j += 2) {
                        const key = cells[j].textContent.trim();
                        const value = cells[j + 1].textContent.trim();
                        data[key] = value;
                    }

                    const result = { ticker, data };
                    tickerCache[ticker] = result;
                    console.log(`[Finviz] âœ… ${ticker} loaded via fallback`);
                    return result;
                } catch (error) {
                    console.warn(`[Finviz] ${ticker} failed:`, error.message);
                    continue;
                }
            }

            console.error(`[Finviz] âŒ All attempts failed for ${ticker}`);
            return { ticker, error: 'All data sources failed' };
        }

        function robustNum(raw) {
            if (raw == null) return null;
            let s = String(raw).trim();
            if (!s || s === '-' || /^n\/a$/i.test(s)) return null;
            let neg = false;
            if (s.startsWith('(') && s.endsWith(')')) { neg = true; s = s.slice(1, -1); }
            s = s.replace(/,/g, '').trim();
            const isPct = s.endsWith('%');
            if (isPct) s = s.slice(0, -1);
            const m = s.match(/^([+-]?\d*\.?\d+)([KMBT])?$/i);
            let v = m ? parseFloat(m[1]) : parseFloat(s);
            if (!isFinite(v)) return null;
            if (m && m[2]) {
                const u = m[2].toUpperCase();
                v *= (u === 'K' ? 1e3 : u === 'M' ? 1e6 : u === 'B' ? 1e9 : 1e12);
            }
            if (neg) v = -v;
            return v;
        }

        function getField(obj, variants) {
            const keys = Object.keys(obj || {});
            for (const v of variants) {
                const k = keys.find(kk => kk.trim().toLowerCase() === v.trim().toLowerCase());
                if (k) return obj[k];
            }
            return undefined;
        }

        function minMax(vals) {
            const a = vals.filter(v => v != null && isFinite(v));
            if (!a.length) return null;
            return { min: Math.min(...a), max: Math.max(...a) };
        }

        function mmNorm(v, st) {
            if (v == null || !st || st.min === st.max) return 0;
            const t = (v - st.min) / (st.max - st.min);
            return Math.max(-1, Math.min(1, t * 2 - 1));
        }

        function buildMetrics(items) {
            return items.map(r => {
                const d = r.data || {};
                const perfW = robustNum(getField(d, ['Perf Week']));
                const perfM = robustNum(getField(d, ['Perf Month']));
                const perfQ = robustNum(getField(d, ['Perf Quarter']));
                const perfH = robustNum(getField(d, ['Perf Half Y']));
                const perfY = robustNum(getField(d, ['Perf Year']));
                const RSI = robustNum(getField(d, ['RSI (14)']));
                const sma200Text = getField(d, ['SMA200']);
                const smaBump = !sma200Text ? 0 : /above/i.test(sma200Text) ? 0.2 : (/below/i.test(sma200Text) ? -0.2 : 0);
                const epsQQ = robustNum(getField(d, ['EPS Q/Q']));
                const salesQQ = robustNum(getField(d, ['Sales Q/Q']));
                const epsNextY = robustNum(getField(d, ['EPS next Y']));
                const gross = robustNum(getField(d, ['Gross Margin']));
                const opmar = robustNum(getField(d, ['Operating Margin']));
                const roe = robustNum(getField(d, ['ROE']));
                const roa = robustNum(getField(d, ['ROA']));
                const pe = robustNum(getField(d, ['P/E']));
                const pfcf = robustNum(getField(d, ['P/FCF']));
                const peg = robustNum(getField(d, ['PEG']));
                const beta = robustNum(getField(d, ['Beta']));
                const M = (perfW ?? 0) * 0.15 + (perfM ?? 0) * 0.25 + (perfQ ?? 0) * 0.30 + (perfH ?? 0) * 0.15 + (perfY ?? 0) * 0.15;
                return {
                    ticker: r.ticker, error: r.error,
                    M, RSI, smaBump, epsQQ, salesQQ, epsNextY, gross, opmar, roe, roa, pe, pfcf, peg, beta
                };
            });
        }

        function scoreAll(items) {
            const m = buildMetrics(items.filter(item => !item.error));
            if (m.length === 0) return items;

            const sM = minMax(m.map(x => x.M));
            const sEPS = minMax(m.map(x => x.epsQQ));
            const sSales = minMax(m.map(x => x.salesQQ));
            const sENY = minMax(m.map(x => x.epsNextY));
            const sGross = minMax(m.map(x => x.gross));
            const sOpm = minMax(m.map(x => x.opmar));
            const sROE = minMax(m.map(x => x.roe));
            const sROA = minMax(m.map(x => x.roa));
            const sPE = minMax(m.map(x => x.pe));
            const sPFCF = minMax(m.map(x => x.pfcf));
            const sPEG = minMax(m.map(x => x.peg));

            return items.map(originalItem => {
                if (originalItem.error) return { ...originalItem, finalScore: -Infinity };

                const x = m.find(metric => metric.ticker === originalItem.ticker);
                if (!x) return { ...originalItem, error: "Metric not found", finalScore: -Infinity };

                const rsiScore = x.RSI == null ? 0 : Math.max(-1, Math.min(1, (x.RSI - 50) / 50));
                const mom = Math.max(-1, Math.min(1, 0.8 * mmNorm(x.M, sM) + 0.2 * rsiScore + x.smaBump));

                const growth = 0.5 * mmNorm(x.epsQQ, sEPS) + 0.3 * mmNorm(x.salesQQ, sSales) + 0.2 * mmNorm(x.epsNextY, sENY);
                const qualityMetrics = [sGross && mmNorm(x.gross, sGross), sOpm && mmNorm(x.opmar, sOpm), sROE && mmNorm(x.roe, sROE), sROA && mmNorm(x.roa, sROA)].filter(v => v !== false);
                const quality = qualityMetrics.length > 0 ? qualityMetrics.reduce((a, b) => a + b, 0) / qualityMetrics.length : 0;
                const fund = Math.max(-1, Math.min(1, 0.7 * growth + 0.3 * quality));

                const valMetrics = [sPEG && -mmNorm(x.peg, sPEG), sPE && -mmNorm(x.pe, sPE), sPFCF && -mmNorm(x.pfcf, sPFCF)].filter(v => v !== false);
                const val = valMetrics.length > 0 ? valMetrics.reduce((a, b) => a + b, 0) / valMetrics.length : 0;

                const risk = (x.beta != null && isFinite(x.beta)) ? (x.beta > 1.5 ? 0.2 : (x.beta < 0.8 ? -0.05 : 0)) : 0;
                const finalScore = Math.max(-1, Math.min(1, 0.45 * mom + 0.35 * fund + 0.20 * val - risk));

                return {
                    ticker: x.ticker,
                    scores: { momentum: mom, fundamental: fund, valuation: val },
                    finalScore,
                    debug: {
                        M: x.M, M_norm: mmNorm(x.M, sM), RSI: x.RSI, rsi_score: rsiScore,
                        sma_bump: x.smaBump,
                        epsQQ: x.epsQQ, epsQQ_norm: mmNorm(x.epsQQ, sEPS), salesQQ: x.salesQQ, salesQQ_norm: mmNorm(x.salesQQ, sSales),
                        peg: x.peg, peg_norm_inv: -mmNorm(x.peg, sPEG), pe: x.pe, pe_norm_inv: -mmNorm(x.pe, sPE),
                        beta: x.beta, risk_penalty: risk
                    }
                };
            });
        }

        function renderBoard(results) {
            results.sort((a, b) => b.finalScore - a.finalScore);
            let finalHtml = '';
            results.forEach((result, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1 && !result.error) rankClass = 'rank-gold';
                else if (rank <= 3 && !result.error) rankClass = 'rank-silver';
                else if (rank <= 5 && !result.error) rankClass = 'rank-bronze';

                const getScoreHTML = (score, debugTooltip) => {
                    let scoreClass = 'score-neutral';
                    if (score > 0.3) scoreClass = 'score-positive';
                    else if (score < -0.3) scoreClass = 'score-negative';
                    const scoreText = score === null ? 'N/A' : score.toFixed(2);
                    return `<div class="tooltip font-bold ${scoreClass}">${scoreText}<span class="tooltiptext">${debugTooltip}</span></div>`;
                };

                const getFinalScoreHTML = (score) => {
                    let scoreClass = 'text-slate-500';
                    if (score > 0.3) scoreClass = 'score-positive';
                    else if (score < -0.3) scoreClass = 'score-negative';
                    return `<span class="font-bold text-lg ${scoreClass}">${score.toFixed(2)}</span>`;
                };

                finalHtml += `<tr class="border-b dark:border-slate-700 ${rankClass}">`;
                finalHtml += `<td class="px-4 py-4 font-bold text-lg text-center align-middle">${rank}</td>`;
                finalHtml += `<td class="px-4 py-4 font-bold text-slate-900 dark:text-slate-100 align-middle">${result.ticker}</td>`;

                if (result.error || !result.scores) {
                    finalHtml += `<td colspan="4" class="px-4 py-4 text-center text-red-500 align-middle">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${result.error || 'N/A'}</td>`;
                } else {
                    const d = result.debug;
                    const momTooltip = `Perf Comp: ${d.M.toFixed(2)} -> ${d.M_norm.toFixed(2)}\nRSI(${d.RSI}): ${d.rsi_score.toFixed(2)}\nSMA Bump: ${d.sma_bump.toFixed(2)}`;
                    const fundTooltip = `EPS Q/Q(${d.epsQQ}%): ${d.epsQQ_norm.toFixed(2)}\nSales Q/Q(${d.salesQQ}%): ${d.salesQQ_norm.toFixed(2)}`;
                    const valTooltip = `PEG(${d.peg}): ${d.peg_norm_inv.toFixed(2)}\nP/E(${d.pe}): ${d.pe_norm_inv.toFixed(2)}`;

                    finalHtml += `<td class="px-4 py-4 text-center align-middle">${getScoreHTML(result.scores.momentum, momTooltip)}</td>`;
                    finalHtml += `<td class="px-4 py-4 text-center align-middle">${getScoreHTML(result.scores.fundamental, fundTooltip)}</td>`;
                    finalHtml += `<td class="px-4 py-4 text-center align-middle">${getScoreHTML(result.scores.valuation, valTooltip)}</td>`;
                    finalHtml += `<td class="px-4 py-4 text-center align-middle">${getFinalScoreHTML(result.finalScore)}</td>`;
                }
                finalHtml += `</tr>`;
            });
            scoreboardBody.innerHTML = finalHtml;
            lastUpdatedEl.textContent = new Date().toLocaleString('ko-KR');
        }

        async function main() {
            const dataStatus = document.getElementById('data-status');
            dataStatus.textContent = 'ğŸ“¡ ë°ì´í„° ë¡œë”© ì¤‘...';
            dataStatus.className = 'text-xs text-blue-500 mt-1';

            showInitialSkeleton();
            const rawResults = [];
            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < TICKERS.length; i++) {
                const ticker = TICKERS[i];
                const statusCell = document.getElementById(`status-cell-${ticker}`);
                if (statusCell) {
                    statusCell.innerHTML = `<span class="text-sm text-slate-500">(${i + 1}/${TICKERS.length}) ë¡œë”© ì¤‘...</span>`;
                }

                dataStatus.textContent = `ğŸ“¡ ë¡œë”© ì¤‘... (${i + 1}/${TICKERS.length})`;

                const result = await fetchTickerData(ticker);
                rawResults.push(result);

                if (result.error) {
                    failCount++;
                } else {
                    successCount++;
                }

                const humanLikeDelay = 500 + Math.random() * 500; // 0.5 to 1 second
                await sleep(humanLikeDelay);
            }

            const scoredResults = scoreAll(rawResults);
            renderBoard(scoredResults);

            // ìºì‹œë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (24ì‹œê°„ ìœ íš¨)
            try {
                localStorage.setItem('wdk_ticker_cache', JSON.stringify(tickerCache));
                localStorage.setItem('wdk_ticker_cache_time', Date.now().toString());
                console.log('[Cache] Saved to localStorage');
            } catch (e) {
                console.warn('[Cache] Failed to save:', e);
            }

            // ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸
            if (failCount === 0) {
                dataStatus.textContent = `âœ… ì „ì²´ ë¡œë”© ì™„ë£Œ! (${successCount}/${TICKERS.length})`;
                dataStatus.className = 'text-xs text-emerald-500 mt-1';
            } else if (successCount > 0) {
                dataStatus.textContent = `âš ï¸ ì¼ë¶€ ì‹¤íŒ¨ (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount})`;
                dataStatus.className = 'text-xs text-amber-500 mt-1';
            } else {
                dataStatus.textContent = `âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨`;
                dataStatus.className = 'text-xs text-red-500 mt-1';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            main();

            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
            document.getElementById('refresh-btn').addEventListener('click', () => {
                main();
            });

            // ìºì‹œ í´ë¦¬ì–´ ë²„íŠ¼
            document.getElementById('clear-cache-btn').addEventListener('click', () => {
                tickerCache = {};
                failedProxies.clear();
                localStorage.removeItem('wdk_ticker_cache');
                localStorage.removeItem('wdk_ticker_cache_time');
                console.log('[Cache] Cleared all cache (memory + localStorage)');
                main();
            });
        });
    </script>
</body>

</html>